<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=yes">
    <title>HTML 5 - Geolocation</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">
    <link rel="stylesheet" type="text/css" href="css/Geolocation.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5compact/"></script>
    <script src="scripts/LocationHelper.js" type="text/javascript"></script>
</head>

<body>
<div data-role="page" id="home">

    <div data-theme="a" data-role="header" data-position="fixed">
        <h3>HTML5 Geolocation</h3>
        <a href="#" data-role="button" data-icon="grid" data-iconpos="notext" onclick="controller.showLocation();">Location</a>
        <a href="#settings" data-role="button" data-icon="gear" class="ui-btn-right" data-iconpos="notext">Settings</a>
    </div>

    <div id="div1">
        <table id="table1" border="1">
            <tr>
                <td>
                    <div id="altitude">ALT: N/A</div>
                </td>
                <td colspan="2">
                    <div id="location">0.00, 0.00</div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="speed">SPD: N/A</div>
                </td>
                <td colspan="2">
                    <div id="timestamp">0:00:00</div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="heading">HDG: N/A</div>
                </td>
                <td>
                    <div id="accuracy">Acc: 0m</div>
                </td>
                <td>
                    <div id="geo-indicator">Geo: OFF</div>
                </td>
            </tr>

        </table>
    </div>

    <div data-role="content">
        <div id="map"></div>
    </div>

</div>

<div data-role="page" id="settings" data-add-back-btn="true">
    <div data-role="header">
        <h1>Settings</h1>
    </div>
    <div data-role="content">

        <div class="settings" style="margin-top: 15px;">
            <div>Geolocation:</div>
            <select name="slider" id="slider-geo-on-off" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div class="settings">
            <div>High Accuracy:</div>
            <select name="slider" id="slider-high-accuracy" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div class="settings-border1">
            <div class="settings-label">Current Position</div>
            <div data-role="fieldcontain">
                <label for="max-age-current-pos">&nbsp;&nbsp;maxAge (ms):</label>
                <input type="text" name="currentPosMaxAge" id="max-age-current-pos" value="60000"  />
            </div>
            <div data-role="fieldcontain">
                <label for="timeout-current-pos">&nbsp;&nbsp;timeout (ms):</label>
                <input type="text" name="currentPosTimeout" id="timeout-current-pos" value="60000"  />
            </div>
            <div class="settings" style="width: 200px; margin-top: 15px;">
                <button data-theme="b" onclick="controller.restartGeo()" data-mini="true">Restart Geo</button>
            </div>
        </div>
        <div class="settings-border1">
            <div class="settings-label2">Watch Position</div>
            <div data-role="fieldcontain">
                <label for="max-age-watch-pos">&nbsp;&nbsp;maxAge (ms):</label>
                <input type="text" name="currentPosMaxAge" id="max-age-watch-pos" value="60000"  />
            </div>
            <div data-role="fieldcontain">
                <label for="timeout-watch-pos">&nbsp;&nbsp;timeout (ms):</label>
                <input type="text" name="currentPosTimeout" id="timeout-watch-pos" value="60000"  />
            </div>
            <div class="settings" style="width: 200px; margin-top: 15px;">
                <button data-theme="b" onclick="controller.restartGeo()" data-mini="true">Restart Geo</button>
            </div>
        </div>
        <div class="settings">
            <div>Accumulate map points:</div>
            <select name="slider" id="slider-accumulate-pts" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div class="settings">
            <div>Handle Errors using alerts:</div>
            <select name="slider" id="slider-handle-errs" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div id="emailDiv" class="settings" style="width: 200px; margin-top: 15px;">
            <button id="sendEmailButton" data-theme="b" onclick="controller.sendEmail()">Email CSV</button>
        </div>
    </div>
</div>


<script type="text/javascript">
    dojo.require("esri.map");

    $('document').ready(function(){
        $("#slider-geo-on-off").on("slidestop",controller.shutOffGeolocation);
        $("#slider-high-accuracy").on("slidestop",controller.toggleHighAccuracy);
        $("#slider-accumulate-pts").on("slidestop",controller.toggleAccumulate);
        $("#slider-handle-err").on("slidestop",controller.toggleErrorAlerts)
    })

    /**
     * View Controller
     * @type {Object}
     */
    var controller = controller || {};

    controller.map = null;
    controller.helper = null;
    controller._MAIL_TO_ADDRESS = "agup@esri.com";

    controller.init = (function() {

        controller.map = new esri.Map("map",{
            basemap:"topo",
            slider: true,
            center: [-104.9, 39.7],
            zoom: 14
        });

        dojo.connect(controller.map, "onZoomEnd", function (extent,zoom,anchor,level){
            controller.helper.zoomLevel = level;
        })

        dojo.connect(controller.map, "onLoad", function () {

            //Adjust the map's zoom slider
            var zoom_slider_left = parseFloat($('#map_zoom_slider').css('left'));
            var zoom_slider_width = parseFloat($('#map_zoom_slider').css('width'));
            $('#div1').css('left',zoom_slider_left * 2 + zoom_slider_width + "px");

            controller.map.reposition();
            controller.map.resize();

            //Don't start location service until after map loads
            controller.helper = new LocationHelper(controller.map);

            controller.helper.mapDiv = $("#map");
            controller.helper.geoIndicatorDiv = $("#geo-indicator");
            controller.helper.locationDiv = $("#location");
            controller.helper.altitudeDiv = $("#altitude");
            controller.helper.speedDiv = $("#speed");
            controller.helper.headingDiv = $("#heading");
            controller.helper.timeStampDiv = $("#timestamp");
            controller.helper.accuracyDiv = $("#accuracy");
            controller.helper.geoSliderOnOff = $("#slider-geo-on-off");

            controller.helper.startGeolocation();
            //Some browsers don't show full height after onLoad

            var supportsOrientationChange = "onorientationchange" in window,
                    orientationEvent = supportsOrientationChange ? "orientationchange" : "resize";

            window.addEventListener(orientationEvent, function () {
                controller.helper.rotateScreen(400);
            }, false);

            //Fix bug in jQuery that destroys map when child view is rotated
            $("div:jqmData(role='page')").on('pagehide',function(){
                controller.helper.viewChange = this.id;
                console.log('view changed ' + controller.map.height + ", " + controller.map.width);
                controller.helper.rotateScreen(400);
            });

        });
    });

    controller.timeoutCurrentPoschange = (function(){
        controller.helper.timeoutCurrentPos = $("#timeout-current-pos").val();
        console.log(controller.helper.timeoutCurrentPos);
    });

    controller.restartGeo = (function restartGeo(){
        var test = confirm("Restart Geolocation?");
        if(test){
            var maxAgeCurrentPos = $("#max-age-current-pos").val();
            var timeoutCurrentPos = $("#timeout-current-pos").val();
            var maxAge = $("#max-age-watch-pos").val();
            var timeout = $("#timeout-watch-pos").val();
            if(controller.isNumber(maxAgeCurrentPos) && controller.isNumber(timeoutCurrentPos) &&
                controller.isNumber(maxAge) && controller.isNumber(timeout)){
                    controller.helper.maxAgeCurrentPos = maxAgeCurrentPos;
                    controller.helper.timeoutCurrentPos = timeoutCurrentPos;
                    controller.helper.timeout = timeout;
                    controller.helper.maximumAge = maxAge;
                    controller.helper.startGeolocation();
            }
            else{
                alert("Check inputs they must be numeric.")
            }
        }
    });

    controller.toggleAccumulate = (function(evt){
        if(evt.target.id == "slider-accumulate-pts" && evt.target.value == "on"){
            controller.helper.accumulate = true;
        }
        else{
            controller.helper.accumulate = false;
        }
    });

    controller.isNumber = (function(value){
        return !isNaN(parseFloat(value)) && isFinite(value);
    });

    controller.showLocation = (function(){
        if($('#div1').is(':visible') == false || $('#div1').is(':hidden')){
            $('#div1').show();
        }
        else{
            $('#div1').hide();
        }

    });

    /**
     * Public function for shutting down the geolocation service.
     */
    controller.shutOffGeolocation = (function(evt){

        if(evt.target.id == "slider-geo-on-off" && evt.target.value == "on"){
            controller.restartGeo();
        }
        else{
            controller.helper.stopGeolocation();
            alert("Geolocation has been shutoff");
        }
    });

    /**
     * Public function for toggling the geolocation high-accuracy property on/off
     */
    controller.toggleHighAccuracy = (function(evt){

        if(evt.target.id == "slider-high-accuracy" && evt.target.value == "on"){
            controller.helper.setHighAccuracy(true);
        }
        else{
            controller.helper.setHighAccuracy(false);
        }

    });

    controller.toggleErrorAlerts = (function(evt){
        if(evt.target.id == "slider-handle-errs" && evt.target.value == "on"){
            controller.helper.useAlerts = true;
        }
        else{
            controller.helper.useAlerts = false;
        }
    });

    /**
     * Public function for emailing a CSV file containing geolocation service information.
     */
   controller.sendEmail = (function(){
        window.open('mailto:'+ controller._MAIL_TO_ADDRESS +'?subject=HTML5 Accuracy Data&body=' +
                encodeURIComponent(controller.helper.getAccuracyCSV()));
    });

    dojo.ready(controller.init);
</script>
</body>
</html>